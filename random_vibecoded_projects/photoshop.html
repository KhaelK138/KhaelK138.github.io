<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoShop Clone</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#1e1e1e;color:#ccc;overflow:hidden;user-select:none}
.app{display:flex;flex-direction:column;height:100vh}
.menubar{display:flex;background:#2d2d2d;padding:4px 8px;gap:16px;font-size:13px;border-bottom:1px solid #3d3d3d}
.menubar span{cursor:pointer;padding:4px 8px;border-radius:3px}
.menubar span:hover{background:#3d3d3d}
.main{display:flex;flex:1;overflow:hidden}
.toolbar{width:48px;background:#2d2d2d;border-right:1px solid #3d3d3d;display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:4px}
.tool{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:4px;font-size:18px;border:2px solid transparent}
.tool:hover{background:#3d3d3d}
.tool.active{background:#4a6da7;border-color:#6a9fd7}
.tool-options{height:32px;background:#2a2a2a;border-bottom:1px solid #3d3d3d;display:flex;align-items:center;padding:0 12px;gap:12px;font-size:12px}
.tool-options label{display:flex;align-items:center;gap:6px}
.tool-options input[type="range"]{width:80px}
.tool-options input[type="color"]{width:32px;height:24px;border:none;background:none;cursor:pointer}
.tool-options input[type="number"]{width:50px;background:#3d3d3d;border:1px solid #555;color:#ccc;padding:2px 4px;border-radius:3px}
.tool-options select{background:#3d3d3d;border:1px solid #555;color:#ccc;padding:2px 6px;border-radius:3px}
.workspace{flex:1;display:flex;flex-direction:column;overflow:hidden}
.canvas-container{flex:1;overflow:auto;background:#1a1a1a;display:flex;align-items:center;justify-content:center;position:relative}
.canvas-wrapper{position:relative;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
#mainCanvas{position:absolute;top:0;left:0;pointer-events:none}
#previewCanvas{position:absolute;top:0;left:0;cursor:crosshair}
.panels{width:280px;background:#2d2d2d;border-left:1px solid #3d3d3d;display:flex;flex-direction:column;overflow:hidden}
.panel{border-bottom:1px solid #3d3d3d}
.panel-header{padding:8px 12px;background:#353535;font-size:12px;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.panel-content{padding:8px;max-height:300px;overflow-y:auto}
.layer{display:flex;align-items:center;padding:6px 8px;gap:8px;cursor:pointer;border-radius:4px;margin-bottom:2px;background:#3a3a3a}
.layer:hover{background:#454545}
.layer.active{background:#4a6da7}
.layer-visibility{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:14px}
.layer-thumb{width:40px;height:40px;background:#2a2a2a;border:1px solid #555;display:flex;align-items:center;justify-content:center;overflow:hidden}
.layer-thumb canvas{max-width:100%;max-height:100%}
.layer-info{flex:1;min-width:0}
.layer-name{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.layer-type{font-size:10px;color:#888}
.layer-actions{display:flex;gap:4px;padding:8px}
.layer-actions button{flex:1;padding:6px;background:#3d3d3d;border:1px solid #555;color:#ccc;cursor:pointer;border-radius:3px;font-size:11px}
.layer-actions button:hover{background:#4d4d4d}
.color-panel{display:flex;gap:8px;align-items:center}
.color-swatch{width:48px;height:48px;border:2px solid #555;cursor:pointer;position:relative}
.color-swatch.fg{z-index:2}
.color-swatch.bg{position:absolute;top:16px;left:16px}
.color-wrapper{position:relative;width:72px;height:72px}
.swap-colors{position:absolute;top:0;right:0;width:20px;height:20px;background:#3d3d3d;border:1px solid #555;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;border-radius:3px}
.history-item{padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px}
.history-item:hover{background:#3d3d3d}
.history-item.current{background:#4a6da7}
.statusbar{height:24px;background:#2d2d2d;border-top:1px solid #3d3d3d;display:flex;align-items:center;padding:0 12px;font-size:11px;gap:24px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#2d2d2d;padding:20px;border-radius:8px;min-width:300px}
.modal-content h3{margin-bottom:16px}
.modal-content label{display:block;margin-bottom:12px}
.modal-content input{width:100%;padding:6px;background:#3d3d3d;border:1px solid #555;color:#ccc;border-radius:3px;margin-top:4px}
.modal-buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.modal-buttons button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer}
.modal-buttons .primary{background:#4a6da7;color:#fff}
.modal-buttons .secondary{background:#3d3d3d;color:#ccc}
.hidden{display:none!important}
.filters-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.filters-grid button{padding:6px;background:#3d3d3d;border:1px solid #555;color:#ccc;cursor:pointer;border-radius:3px;font-size:11px}
.filters-grid button:hover{background:#4d4d4d}
.blend-mode{margin-bottom:8px}
.blend-mode select{width:100%}
.opacity-slider{display:flex;align-items:center;gap:8px}
.opacity-slider input{flex:1}
</style>
</head>
<body>
<div class="app">
<div class="menubar">
<span onclick="showNewDialog()">File</span>
<span onclick="editMenu()">Edit</span>
<span onclick="imageMenu()">Image</span>
<span onclick="filterMenu()">Filter</span>
<span onclick="viewMenu()">View</span>
</div>
<div class="tool-options" id="toolOptions">
<label>Size: <input type="range" id="brushSize" min="1" max="200" value="20"><span id="brushSizeVal">20</span>px</label>
<label>Opacity: <input type="range" id="brushOpacity" min="1" max="100" value="100"><span id="brushOpacityVal">100</span>%</label>
<label>Hardness: <input type="range" id="brushHardness" min="0" max="100" value="100"><span id="brushHardnessVal">100</span>%</label>
</div>
<div class="main">
<div class="toolbar">
<div class="tool active" data-tool="brush" title="Brush (B)">üñåÔ∏è</div>
<div class="tool" data-tool="eraser" title="Eraser (E)">üßΩ</div>
<div class="tool" data-tool="pencil" title="Pencil (P)">‚úèÔ∏è</div>
<div class="tool" data-tool="fill" title="Paint Bucket (G)">ü™£</div>
<div class="tool" data-tool="eyedropper" title="Eyedropper (I)">üíâ</div>
<div class="tool" data-tool="rect" title="Rectangle (U)">‚¨ú</div>
<div class="tool" data-tool="ellipse" title="Ellipse (U)">‚≠ï</div>
<div class="tool" data-tool="line" title="Line (U)">üìè</div>
<div class="tool" data-tool="text" title="Text (T)">T</div>
<div class="tool" data-tool="move" title="Move (V)">‚ú•</div>
<div class="tool" data-tool="select" title="Selection (M)">‚¨ö</div>
<div class="tool" data-tool="gradient" title="Gradient (G)">üåà</div>
<div class="tool" data-tool="blur" title="Blur">üíß</div>
<div class="tool" data-tool="sharpen" title="Sharpen">üî∫</div>
</div>
<div class="workspace">
<div class="canvas-container" id="canvasContainer">
<div class="canvas-wrapper" id="canvasWrapper">
<canvas id="mainCanvas"></canvas>
<canvas id="previewCanvas"></canvas>
</div>
</div>
</div>
<div class="panels">
<div class="panel">
<div class="panel-header">Colors</div>
<div class="panel-content">
<div class="color-panel">
<div class="color-wrapper">
<div class="color-swatch fg" id="fgColor" style="background:#000" onclick="pickColor('fg')"></div>
<div class="color-swatch bg" id="bgColor" style="background:#fff" onclick="pickColor('bg')"></div>
<div class="swap-colors" onclick="swapColors()">‚áÑ</div>
</div>
<input type="color" id="colorPicker" class="hidden">
</div>
</div>
</div>
<div class="panel">
<div class="panel-header">Layers <span id="layerCount">1</span></div>
<div class="panel-content">
<div class="blend-mode">
<select id="blendMode" onchange="changeBlendMode()">
<option value="source-over">Normal</option>
<option value="multiply">Multiply</option>
<option value="screen">Screen</option>
<option value="overlay">Overlay</option>
<option value="darken">Darken</option>
<option value="lighten">Lighten</option>
<option value="color-dodge">Color Dodge</option>
<option value="color-burn">Color Burn</option>
<option value="hard-light">Hard Light</option>
<option value="soft-light">Soft Light</option>
<option value="difference">Difference</option>
<option value="exclusion">Exclusion</option>
<option value="hue">Hue</option>
<option value="saturation">Saturation</option>
<option value="color">Color</option>
<option value="luminosity">Luminosity</option>
</select>
</div>
<div class="opacity-slider">
<span>Opacity:</span>
<input type="range" id="layerOpacity" min="0" max="100" value="100" onchange="changeLayerOpacity()">
<span id="layerOpacityVal">100%</span>
</div>
<div id="layersList"></div>
<div class="layer-actions">
<button onclick="addLayer()">+ Add</button>
<button onclick="duplicateLayer()">‚ßâ Dup</button>
<button onclick="mergeDown()">‚§ì Merge</button>
<button onclick="deleteLayer()">üóë Del</button>
</div>
</div>
</div>
<div class="panel">
<div class="panel-header">History</div>
<div class="panel-content" id="historyList"></div>
</div>
<div class="panel">
<div class="panel-header">Quick Filters</div>
<div class="panel-content">
<div class="filters-grid">
<button onclick="applyFilter('grayscale')">Grayscale</button>
<button onclick="applyFilter('invert')">Invert</button>
<button onclick="applyFilter('sepia')">Sepia</button>
<button onclick="applyFilter('brightness')">Brighten</button>
<button onclick="applyFilter('contrast')">Contrast</button>
<button onclick="applyFilter('saturate')">Saturate</button>
<button onclick="applyFilter('blur')">Blur</button>
<button onclick="applyFilter('sharpen')">Sharpen</button>
</div>
</div>
</div>
</div>
</div>
<div class="statusbar">
<span id="statusCoords">X: 0, Y: 0</span>
<span id="statusSize">800 √ó 600</span>
<span id="statusZoom">100%</span>
<span id="statusTool">Brush</span>
</div>
</div>
<div class="modal hidden" id="newDocModal">
<div class="modal-content">
<h3>New Document</h3>
<label>Width: <input type="number" id="newWidth" value="800"></label>
<label>Height: <input type="number" id="newHeight" value="600"></label>
<label>Background:
<select id="newBg">
<option value="white">White</option>
<option value="transparent">Transparent</option>
<option value="black">Black</option>
</select>
</label>
<div class="modal-buttons">
<button class="secondary" onclick="closeModals()">Cancel</button>
<button class="primary" onclick="createNewDoc()">Create</button>
</div>
</div>
</div>
<div class="modal hidden" id="textModal">
<div class="modal-content">
<h3>Add Text</h3>
<label>Text: <input type="text" id="textInput" value=""></label>
<label>Font Size: <input type="number" id="textSize" value="48"></label>
<label>Font:
<select id="textFont">
<option value="Arial">Arial</option>
<option value="Georgia">Georgia</option>
<option value="Times New Roman">Times New Roman</option>
<option value="Courier New">Courier New</option>
<option value="Verdana">Verdana</option>
<option value="Impact">Impact</option>
</select>
</label>
<div class="modal-buttons">
<button class="secondary" onclick="closeModals()">Cancel</button>
<button class="primary" onclick="confirmText()">Add</button>
</div>
</div>
</div>
<input type="file" id="fileInput" accept="image/*" class="hidden">
<script>
const mainCanvas=document.getElementById('mainCanvas'),previewCanvas=document.getElementById('previewCanvas'),ctx=mainCanvas.getContext('2d'),previewCtx=previewCanvas.getContext('2d');
let W=800,H=600,layers=[],activeLayerIdx=0,currentTool='brush',fgColor='#000000',bgColor='#ffffff',brushSize=20,brushOpacity=100,brushHardness=100,isDrawing=false,lastX=0,lastY=0,history=[],historyIdx=-1,selection=null,zoom=1,textPos=null;
function init(){
mainCanvas.width=previewCanvas.width=W;
mainCanvas.height=previewCanvas.height=H;
document.getElementById('canvasWrapper').style.width=W+'px';
document.getElementById('canvasWrapper').style.height=H+'px';
addLayer('Background',true);
updateStatus();
setupEvents();
render();
}
function Layer(name,w,h,fill){
this.name=name;
this.canvas=document.createElement('canvas');
this.canvas.width=w;
this.canvas.height=h;
this.ctx=this.canvas.getContext('2d');
this.visible=true;
this.opacity=1;
this.blendMode='source-over';
if(fill){this.ctx.fillStyle=fill;this.ctx.fillRect(0,0,w,h);}
}
function addLayer(name,fill){
const n=name||'Layer '+(layers.length+1);
const l=new Layer(n,W,H,fill?'#ffffff':null);
layers.unshift(l);
activeLayerIdx=0;
updateLayersUI();
saveHistory('Add Layer');
}
function duplicateLayer(){
if(!layers.length)return;
const src=layers[activeLayerIdx];
const l=new Layer(src.name+' copy',W,H);
l.ctx.drawImage(src.canvas,0,0);
l.opacity=src.opacity;
l.blendMode=src.blendMode;
layers.splice(activeLayerIdx,0,l);
updateLayersUI();
render();
saveHistory('Duplicate Layer');
}
function deleteLayer(){
if(layers.length<=1)return;
layers.splice(activeLayerIdx,1);
if(activeLayerIdx>=layers.length)activeLayerIdx=layers.length-1;
updateLayersUI();
render();
saveHistory('Delete Layer');
}
function mergeDown(){
if(activeLayerIdx>=layers.length-1)return;
const top=layers[activeLayerIdx],bot=layers[activeLayerIdx+1];
bot.ctx.globalAlpha=top.opacity;
bot.ctx.globalCompositeOperation=top.blendMode;
bot.ctx.drawImage(top.canvas,0,0);
bot.ctx.globalAlpha=1;
bot.ctx.globalCompositeOperation='source-over';
layers.splice(activeLayerIdx,1);
updateLayersUI();
render();
saveHistory('Merge Down');
}
function selectLayer(idx){
activeLayerIdx=idx;
const l=layers[idx];
document.getElementById('blendMode').value=l.blendMode;
document.getElementById('layerOpacity').value=l.opacity*100;
document.getElementById('layerOpacityVal').textContent=Math.round(l.opacity*100)+'%';
updateLayersUI();
}
function changeBlendMode(){
layers[activeLayerIdx].blendMode=document.getElementById('blendMode').value;
render();
}
function changeLayerOpacity(){
const v=document.getElementById('layerOpacity').value;
layers[activeLayerIdx].opacity=v/100;
document.getElementById('layerOpacityVal').textContent=v+'%';
render();
}
function toggleLayerVisibility(idx,e){
e.stopPropagation();
layers[idx].visible=!layers[idx].visible;
updateLayersUI();
render();
}
function updateLayersUI(){
const list=document.getElementById('layersList');
list.innerHTML='';
document.getElementById('layerCount').textContent=layers.length;
layers.forEach((l,i)=>{
const div=document.createElement('div');
div.className='layer'+(i===activeLayerIdx?' active':'');
div.onclick=()=>selectLayer(i);
div.innerHTML=`<div class="layer-visibility" onclick="toggleLayerVisibility(${i},event)">${l.visible?'üëÅ':'‚óã'}</div><div class="layer-thumb"><canvas width="40" height="40"></canvas></div><div class="layer-info"><div class="layer-name">${l.name}</div><div class="layer-type">${Math.round(l.opacity*100)}%</div></div>`;
const thumb=div.querySelector('canvas');
const tctx=thumb.getContext('2d');
tctx.fillStyle='#888';
for(let y=0;y<40;y+=10)for(let x=0;x<40;x+=10)if((x+y)%20===0)tctx.fillRect(x,y,10,10);
tctx.drawImage(l.canvas,0,0,40,40);
list.appendChild(div);
});
}
function render(){
ctx.clearRect(0,0,W,H);
ctx.fillStyle='#888';
for(let y=0;y<H;y+=20)for(let x=0;x<W;x+=20)if((x+y)%40===0)ctx.fillRect(x,y,20,20);
for(let i=layers.length-1;i>=0;i--){
const l=layers[i];
if(!l.visible)continue;
ctx.globalAlpha=l.opacity;
ctx.globalCompositeOperation=l.blendMode;
ctx.drawImage(l.canvas,0,0);
}
ctx.globalAlpha=1;
ctx.globalCompositeOperation='source-over';
if(selection){
ctx.strokeStyle='#fff';
ctx.lineWidth=1;
ctx.setLineDash([5,5]);
ctx.strokeRect(selection.x,selection.y,selection.w,selection.h);
ctx.setLineDash([]);
}
}
function getPos(e){
const r=previewCanvas.getBoundingClientRect();
return{x:(e.clientX-r.left)/zoom,y:(e.clientY-r.top)/zoom};
}
function setupEvents(){
const tools=document.querySelectorAll('.tool');
tools.forEach(t=>t.onclick=()=>{
tools.forEach(x=>x.classList.remove('active'));
t.classList.add('active');
currentTool=t.dataset.tool;
document.getElementById('statusTool').textContent=t.title.split('(')[0].trim();
});
previewCanvas.onmousedown=e=>{
e.preventDefault();
const p=getPos(e);
lastX=p.x;lastY=p.y;
if(currentTool==='eyedropper'){
eyedrop(p.x,p.y);
return;
}
if(currentTool==='fill'){
floodFill(Math.floor(p.x),Math.floor(p.y));
return;
}
if(currentTool==='text'){
textPos=p;
document.getElementById('textModal').classList.remove('hidden');
document.getElementById('textInput').focus();
return;
}
isDrawing=true;
if(['rect','ellipse','line','select','gradient'].includes(currentTool)){
startShape=p;
}else{
const l=layers[activeLayerIdx];
if(l&&l.visible){
l.ctx.beginPath();
l.ctx.moveTo(p.x,p.y);
}
draw(p.x,p.y);
}
};
previewCanvas.onmousemove=e=>{
const p=getPos(e);
document.getElementById('statusCoords').textContent=`X: ${Math.round(p.x)}, Y: ${Math.round(p.y)}`;
if(!isDrawing)return;
if(['rect','ellipse','line','select','gradient'].includes(currentTool)){
drawShapePreview(p);
}else{
draw(p.x,p.y);
lastX=p.x;lastY=p.y;
}
};
previewCanvas.onmouseup=e=>{
// Handled by window.onmouseup
};
previewCanvas.onmouseleave=()=>{if(isDrawing&&!['rect','ellipse','line','select','gradient'].includes(currentTool)){isDrawing=false;saveHistory('Draw');}};
window.onmouseup=e=>{
if(isDrawing){
isDrawing=false;
const p=getPos(e);
if(['rect','ellipse','line'].includes(currentTool)&&startShape){
commitShape(p);
saveHistory('Draw '+currentTool);
}else if(currentTool==='select'&&startShape){
selection={x:Math.min(startShape.x,p.x),y:Math.min(startShape.y,p.y),w:Math.abs(p.x-startShape.x),h:Math.abs(p.y-startShape.y)};
render();
}else if(currentTool==='gradient'&&startShape){
drawGradient(startShape,p);
saveHistory('Gradient');
}else{
saveHistory('Draw');
}
previewCtx.clearRect(0,0,W,H);
startShape=null;
}
};
const bs=document.getElementById('brushSize');
bs.oninput=()=>{brushSize=+bs.value;document.getElementById('brushSizeVal').textContent=bs.value;};
const bo=document.getElementById('brushOpacity');
bo.oninput=()=>{brushOpacity=+bo.value;document.getElementById('brushOpacityVal').textContent=bo.value;};
const bh=document.getElementById('brushHardness');
bh.oninput=()=>{brushHardness=+bh.value;document.getElementById('brushHardnessVal').textContent=bh.value;};
document.addEventListener('keydown',e=>{
if(e.target.tagName==='INPUT')return;
const k=e.key.toLowerCase();
const ctrl=e.ctrlKey||e.metaKey;
const shift=e.shiftKey;
const alt=e.altKey;

// Undo/Redo - Ctrl+Z, Ctrl+Shift+Z, Ctrl+Y
if(ctrl&&shift&&k==='z'){e.preventDefault();redo();return;}
if(ctrl&&k==='z'){e.preventDefault();undo();return;}
if(ctrl&&k==='y'){e.preventDefault();redo();return;}

// File operations
if(ctrl&&k==='n'){e.preventDefault();showNewDialog();return;}
if(ctrl&&k==='o'){e.preventDefault();document.getElementById('fileInput').click();return;}
if(ctrl&&k==='s'){e.preventDefault();saveImage();return;}
if(ctrl&&shift&&k==='s'){e.preventDefault();saveImage('png');return;}
if(ctrl&&shift&&k==='e'){e.preventDefault();exportFlattened();return;}

// Edit operations
if(ctrl&&k==='a'){e.preventDefault();selection={x:0,y:0,w:W,h:H};render();return;}
if(ctrl&&k==='d'){e.preventDefault();selection=null;render();return;}
if(ctrl&&shift&&k==='i'){e.preventDefault();invertSelection();return;}
if(ctrl&&k==='c'){e.preventDefault();copySelection();return;}
if(ctrl&&k==='x'){e.preventDefault();cutSelection();return;}
if(ctrl&&k==='j'){e.preventDefault();duplicateLayer();return;}
if(ctrl&&k==='e'){e.preventDefault();mergeDown();return;}
if(ctrl&&shift&&k==='n'){e.preventDefault();addLayer();return;}

// Transform
if(ctrl&&k==='t'){e.preventDefault();/* transform mode placeholder */return;}

// View
if(ctrl&&k==='0'){e.preventDefault();zoom=1;applyZoom();return;}
if(ctrl&&(k==='='||k==='+')){e.preventDefault();zoom=Math.min(4,zoom*1.25);applyZoom();return;}
if(ctrl&&k==='-'){e.preventDefault();zoom=Math.max(0.1,zoom/1.25);applyZoom();return;}

// Fill shortcuts
if(alt&&k==='backspace'){e.preventDefault();fillWithColor(fgColor);return;}
if(ctrl&&k==='backspace'){e.preventDefault();fillWithColor(bgColor);return;}
if(k==='delete'||k==='backspace'){if(selection){e.preventDefault();deleteSelection();return;}}

// Tool shortcuts
if(k==='b')selectToolByName('brush');
if(k==='e')selectToolByName('eraser');
if(k==='p')selectToolByName('pencil');
if(k==='g'){shift?selectToolByName('gradient'):selectToolByName('fill');}
if(k==='i')selectToolByName('eyedropper');
if(k==='t')selectToolByName('text');
if(k==='v')selectToolByName('move');
if(k==='m')selectToolByName('select');
if(k==='u'){
const shapeTools=['rect','ellipse','line'];
const curr=shapeTools.indexOf(currentTool);
selectToolByName(shapeTools[(curr+1)%shapeTools.length]);
}
if(k==='l')selectToolByName('line');
if(k==='r')selectToolByName('blur');

// Brush size - [ and ]
if(k==='['){brushSize=Math.max(1,brushSize-(shift?10:5));document.getElementById('brushSize').value=brushSize;document.getElementById('brushSizeVal').textContent=brushSize;}
if(k===']'){brushSize=Math.min(200,brushSize+(shift?10:5));document.getElementById('brushSize').value=brushSize;document.getElementById('brushSizeVal').textContent=brushSize;}

// Swap colors
if(k==='x')swapColors();
// Reset colors to default (black/white)
if(k==='d'&&!ctrl){fgColor='#000000';bgColor='#ffffff';document.getElementById('fgColor').style.background=fgColor;document.getElementById('bgColor').style.background=bgColor;}

// Opacity shortcuts 1-0
if(!ctrl&&!alt&&k>='1'&&k<='9'){brushOpacity=parseInt(k)*10;document.getElementById('brushOpacity').value=brushOpacity;document.getElementById('brushOpacityVal').textContent=brushOpacity;}
if(!ctrl&&!alt&&k==='0'){brushOpacity=100;document.getElementById('brushOpacity').value=brushOpacity;document.getElementById('brushOpacityVal').textContent=brushOpacity;}

// Tab to hide/show panels
if(k==='tab'){e.preventDefault();document.querySelector('.panels').classList.toggle('hidden');document.querySelector('.toolbar').classList.toggle('hidden');}

// Space for pan (just prevent default for now)
if(k===' '){e.preventDefault();}

// F for fullscreen fit
if(k==='f'&&!ctrl){const cont=document.getElementById('canvasContainer');zoom=Math.min(cont.clientWidth/W,cont.clientHeight/H)*0.9;applyZoom();}
});
document.addEventListener('paste',e=>{
// Check for copied selection data first
if(window.copiedData){
const l=new Layer('Pasted Layer',W,H);
l.ctx.putImageData(window.copiedData.imgData,selection?selection.x:0,selection?selection.y:0);
layers.unshift(l);
activeLayerIdx=0;
updateLayersUI();
render();
saveHistory('Paste');
return;
}
const items=e.clipboardData.items;
for(let i=0;i<items.length;i++){
if(items[i].type.indexOf('image')!==-1){
const blob=items[i].getAsFile();
const img=new Image();
img.onload=()=>{
const l=new Layer('Pasted Image',W,H);
l.ctx.drawImage(img,0,0);
layers.unshift(l);
activeLayerIdx=0;
updateLayersUI();
render();
saveHistory('Paste Image');
URL.revokeObjectURL(img.src);
};
img.src=URL.createObjectURL(blob);
break;
}
}
});
document.getElementById('fileInput').onchange=e=>{
const f=e.target.files[0];
if(f){
const img=new Image();
img.onload=()=>{
const l=new Layer(f.name,W,H);
l.ctx.drawImage(img,0,0);
layers.unshift(l);
activeLayerIdx=0;
updateLayersUI();
render();
saveHistory('Import Image');
};
img.src=URL.createObjectURL(f);
}
};
}
let startShape=null;
function selectToolByName(name){
document.querySelectorAll('.tool').forEach(t=>{
if(t.dataset.tool===name){t.click();}
});
}
function draw(x,y){
const l=layers[activeLayerIdx];
if(!l||!l.visible)return;
const c=l.ctx;
if(currentTool==='eraser'){
c.globalCompositeOperation='destination-out';
}else{
c.globalCompositeOperation='source-over';
}
c.lineCap='round';
c.lineJoin='round';
c.lineWidth=currentTool==='pencil'?1:brushSize;
c.strokeStyle=fgColor;
c.globalAlpha=brushOpacity/100;
if(currentTool==='blur'||currentTool==='sharpen'){
applyLocalEffect(x,y,currentTool);
}else if(brushHardness<100&&currentTool!=='pencil'&&currentTool!=='eraser'){
const dist=Math.sqrt((x-lastX)**2+(y-lastY)**2);
const steps=Math.max(1,Math.floor(dist/2));
for(let i=0;i<=steps;i++){
const px=lastX+(x-lastX)*(i/steps);
const py=lastY+(y-lastY)*(i/steps);
const grad=c.createRadialGradient(px,py,0,px,py,brushSize/2);
grad.addColorStop(0,fgColor);
grad.addColorStop(brushHardness/100,fgColor);
grad.addColorStop(1,'transparent');
c.fillStyle=grad;
c.beginPath();
c.arc(px,py,brushSize/2,0,Math.PI*2);
c.fill();
}
}else{
c.lineTo(x,y);
c.stroke();
c.beginPath();
c.moveTo(x,y);
}
c.globalAlpha=1;
c.globalCompositeOperation='source-over';
render();
}
function applyLocalEffect(x,y,type){
const l=layers[activeLayerIdx];
const r=Math.floor(brushSize/2);
const sx=Math.max(0,Math.floor(x-r)),sy=Math.max(0,Math.floor(y-r));
const sw=Math.min(W-sx,r*2),sh=Math.min(H-sy,r*2);
if(sw<=0||sh<=0)return;
const imgData=l.ctx.getImageData(sx,sy,sw,sh);
const d=imgData.data;
if(type==='blur'){
for(let i=0;i<d.length;i+=4){
const avg=(d[i]+d[i+1]+d[i+2])/3;
d[i]=d[i]*0.9+avg*0.1;
d[i+1]=d[i+1]*0.9+avg*0.1;
d[i+2]=d[i+2]*0.9+avg*0.1;
}
}
l.ctx.putImageData(imgData,sx,sy);
}
function drawShapePreview(p){
previewCtx.clearRect(0,0,W,H);
previewCtx.strokeStyle=fgColor;
previewCtx.fillStyle=fgColor;
previewCtx.lineWidth=brushSize;
previewCtx.globalAlpha=brushOpacity/100;
const x=Math.min(startShape.x,p.x),y=Math.min(startShape.y,p.y);
const w=Math.abs(p.x-startShape.x),h=Math.abs(p.y-startShape.y);
if(currentTool==='rect'){
previewCtx.strokeRect(x,y,w,h);
}else if(currentTool==='ellipse'){
previewCtx.beginPath();
previewCtx.ellipse(x+w/2,y+h/2,w/2,h/2,0,0,Math.PI*2);
previewCtx.stroke();
}else if(currentTool==='line'){
previewCtx.beginPath();
previewCtx.moveTo(startShape.x,startShape.y);
previewCtx.lineTo(p.x,p.y);
previewCtx.stroke();
}else if(currentTool==='select'){
previewCtx.strokeStyle='#fff';
previewCtx.lineWidth=1;
previewCtx.setLineDash([5,5]);
previewCtx.strokeRect(x,y,w,h);
previewCtx.setLineDash([]);
}else if(currentTool==='gradient'){
const grad=previewCtx.createLinearGradient(startShape.x,startShape.y,p.x,p.y);
grad.addColorStop(0,fgColor);
grad.addColorStop(1,bgColor);
previewCtx.fillStyle=grad;
previewCtx.fillRect(0,0,W,H);
}
previewCtx.globalAlpha=1;
}
function commitShape(p){
const l=layers[activeLayerIdx];
const c=l.ctx;
c.strokeStyle=fgColor;
c.fillStyle=fgColor;
c.lineWidth=brushSize;
c.globalAlpha=brushOpacity/100;
const x=Math.min(startShape.x,p.x),y=Math.min(startShape.y,p.y);
const w=Math.abs(p.x-startShape.x),h=Math.abs(p.y-startShape.y);
if(currentTool==='rect'){
c.strokeRect(x,y,w,h);
}else if(currentTool==='ellipse'){
c.beginPath();
c.ellipse(x+w/2,y+h/2,w/2,h/2,0,0,Math.PI*2);
c.stroke();
}else if(currentTool==='line'){
c.beginPath();
c.moveTo(startShape.x,startShape.y);
c.lineTo(p.x,p.y);
c.stroke();
}
c.globalAlpha=1;
render();
}
function drawGradient(start,end){
const l=layers[activeLayerIdx];
const c=l.ctx;
const grad=c.createLinearGradient(start.x,start.y,end.x,end.y);
grad.addColorStop(0,fgColor);
grad.addColorStop(1,bgColor);
c.globalAlpha=brushOpacity/100;
if(selection){
c.fillStyle=grad;
c.fillRect(selection.x,selection.y,selection.w,selection.h);
}else{
c.fillStyle=grad;
c.fillRect(0,0,W,H);
}
c.globalAlpha=1;
previewCtx.clearRect(0,0,W,H);
render();
}
function floodFill(sx,sy){
const l=layers[activeLayerIdx];
const imgData=l.ctx.getImageData(0,0,W,H);
const d=imgData.data;
const idx=(sy*W+sx)*4;
const tr=d[idx],tg=d[idx+1],tb=d[idx+2],ta=d[idx+3];
const fr=parseInt(fgColor.slice(1,3),16),fg_=parseInt(fgColor.slice(3,5),16),fb=parseInt(fgColor.slice(5,7),16);
if(tr===fr&&tg===fg_&&tb===fb)return;
const stack=[[sx,sy]];
const visited=new Set();
while(stack.length){
const[x,y]=stack.pop();
if(x<0||x>=W||y<0||y>=H)continue;
const k=y*W+x;
if(visited.has(k))continue;
const i=k*4;
if(d[i]!==tr||d[i+1]!==tg||d[i+2]!==tb||d[i+3]!==ta)continue;
visited.add(k);
d[i]=fr;d[i+1]=fg_;d[i+2]=fb;d[i+3]=255;
stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
}
l.ctx.putImageData(imgData,0,0);
render();
saveHistory('Fill');
}
function eyedrop(x,y){
const imgData=ctx.getImageData(Math.floor(x),Math.floor(y),1,1).data;
fgColor='#'+[imgData[0],imgData[1],imgData[2]].map(v=>v.toString(16).padStart(2,'0')).join('');
document.getElementById('fgColor').style.background=fgColor;
}
function deleteSelection(){
if(!selection)return;
const l=layers[activeLayerIdx];
l.ctx.clearRect(selection.x,selection.y,selection.w,selection.h);
render();
saveHistory('Delete Selection');
}
function applyFilter(type){
const l=layers[activeLayerIdx];
const c=l.ctx;
let sx=0,sy=0,sw=W,sh=H;
if(selection){sx=selection.x;sy=selection.y;sw=selection.w;sh=selection.h;}
const imgData=c.getImageData(sx,sy,sw,sh);
const d=imgData.data;
for(let i=0;i<d.length;i+=4){
let r=d[i],g=d[i+1],b=d[i+2];
if(type==='grayscale'){const v=0.3*r+0.59*g+0.11*b;r=g=b=v;}
else if(type==='invert'){r=255-r;g=255-g;b=255-b;}
else if(type==='sepia'){const tr=0.393*r+0.769*g+0.189*b;const tg=0.349*r+0.686*g+0.168*b;const tb=0.272*r+0.534*g+0.131*b;r=tr;g=tg;b=tb;}
else if(type==='brightness'){r+=30;g+=30;b+=30;}
else if(type==='contrast'){const f=1.2;r=(r-128)*f+128;g=(g-128)*f+128;b=(b-128)*f+128;}
else if(type==='saturate'){const avg=(r+g+b)/3;r+=(r-avg)*0.5;g+=(g-avg)*0.5;b+=(b-avg)*0.5;}
d[i]=Math.max(0,Math.min(255,r));
d[i+1]=Math.max(0,Math.min(255,g));
d[i+2]=Math.max(0,Math.min(255,b));
}
if(type==='blur'){
const w=sw,h=sh;
const copy=new Uint8ClampedArray(d);
for(let y=1;y<h-1;y++){
for(let x=1;x<w-1;x++){
for(let c=0;c<3;c++){
const i=(y*w+x)*4+c;
d[i]=(copy[i-w*4]+copy[i+w*4]+copy[i-4]+copy[i+4]+copy[i]*4)/8;
}
}
}
}
if(type==='sharpen'){
const w=sw,h=sh;
const copy=new Uint8ClampedArray(d);
for(let y=1;y<h-1;y++){
for(let x=1;x<w-1;x++){
for(let c=0;c<3;c++){
const i=(y*w+x)*4+c;
const v=copy[i]*5-copy[i-w*4]-copy[i+w*4]-copy[i-4]-copy[i+4];
d[i]=Math.max(0,Math.min(255,v));
}
}
}
}
c.putImageData(imgData,sx,sy);
render();
saveHistory('Filter: '+type);
}
function confirmText(){
const txt=document.getElementById('textInput').value;
if(!txt||!textPos)return;
const l=layers[activeLayerIdx];
const size=document.getElementById('textSize').value;
const font=document.getElementById('textFont').value;
l.ctx.font=size+'px '+font;
l.ctx.fillStyle=fgColor;
l.ctx.fillText(txt,textPos.x,textPos.y);
closeModals();
render();
saveHistory('Add Text');
}
function saveHistory(action){
history=history.slice(0,historyIdx+1);
const state=layers.map(l=>{
const c=document.createElement('canvas');
c.width=W;c.height=H;
c.getContext('2d').drawImage(l.canvas,0,0);
return{name:l.name,canvas:c,visible:l.visible,opacity:l.opacity,blendMode:l.blendMode};
});
history.push({action,state,activeIdx:activeLayerIdx});
historyIdx++;
if(history.length>50){history.shift();historyIdx--;}
updateHistoryUI();
}
function restoreState(idx){
const h=history[idx];
layers=h.state.map(s=>{
const l=new Layer(s.name,W,H);
l.ctx.drawImage(s.canvas,0,0);
l.visible=s.visible;
l.opacity=s.opacity;
l.blendMode=s.blendMode;
return l;
});
activeLayerIdx=h.activeIdx;
updateLayersUI();
render();
}
function undo(){if(historyIdx>0){historyIdx--;restoreState(historyIdx);updateHistoryUI();}}
function redo(){if(historyIdx<history.length-1){historyIdx++;restoreState(historyIdx);updateHistoryUI();}}
function updateHistoryUI(){
const list=document.getElementById('historyList');
list.innerHTML='';
history.forEach((h,i)=>{
const div=document.createElement('div');
div.className='history-item'+(i===historyIdx?' current':'');
div.textContent=h.action;
div.onclick=()=>{historyIdx=i;restoreState(i);updateHistoryUI();};
list.appendChild(div);
});
list.scrollTop=list.scrollHeight;
}
function pickColor(which){
const picker=document.getElementById('colorPicker');
picker.value=which==='fg'?fgColor:bgColor;
picker.onclick=null;
picker.oninput=()=>{
if(which==='fg'){fgColor=picker.value;document.getElementById('fgColor').style.background=fgColor;}
else{bgColor=picker.value;document.getElementById('bgColor').style.background=bgColor;}
};
picker.click();
}
function swapColors(){
[fgColor,bgColor]=[bgColor,fgColor];
document.getElementById('fgColor').style.background=fgColor;
document.getElementById('bgColor').style.background=bgColor;
}
function showNewDialog(){document.getElementById('newDocModal').classList.remove('hidden');}
function closeModals(){document.querySelectorAll('.modal').forEach(m=>m.classList.add('hidden'));}
function createNewDoc(){
W=+document.getElementById('newWidth').value||800;
H=+document.getElementById('newHeight').value||600;
const bg=document.getElementById('newBg').value;
mainCanvas.width=previewCanvas.width=W;
mainCanvas.height=previewCanvas.height=H;
document.getElementById('canvasWrapper').style.width=W+'px';
document.getElementById('canvasWrapper').style.height=H+'px';
layers=[];
history=[];
historyIdx=-1;
const fill=bg==='white'?'#ffffff':bg==='black'?'#000000':null;
addLayer('Background',bg!=='transparent');
if(fill&&bg!=='transparent')layers[0].ctx.fillStyle=fill;
if(fill&&bg!=='transparent')layers[0].ctx.fillRect(0,0,W,H);
closeModals();
updateStatus();
render();
}
function editMenu(){
const m=prompt('Edit Menu:\n1. Undo (Ctrl+Z)\n2. Redo (Ctrl+Y)\n3. Deselect (Ctrl+D)\n\nEnter number:');
if(m==='1')undo();
if(m==='2')redo();
if(m==='3'){selection=null;render();}
}
function imageMenu(){
const m=prompt('Image Menu:\n1. Canvas Size\n2. Flip Horizontal\n3. Flip Vertical\n4. Rotate 90¬∞ CW\n5. Import Image\n\nEnter number:');
if(m==='1'){
const nw=prompt('New width:',W);
const nh=prompt('New height:',H);
if(nw&&nh)resizeCanvas(+nw,+nh);
}
if(m==='2')flipLayer('h');
if(m==='3')flipLayer('v');
if(m==='4')rotateLayer();
if(m==='5')document.getElementById('fileInput').click();
}
function filterMenu(){
const m=prompt('Filter Menu:\n1. Grayscale\n2. Invert\n3. Sepia\n4. Brightness\n5. Contrast\n6. Blur\n7. Sharpen\n\nEnter number:');
const filters=['grayscale','invert','sepia','brightness','contrast','blur','sharpen'];
if(m>=1&&m<=7)applyFilter(filters[m-1]);
}
function viewMenu(){
const m=prompt('View Menu:\n1. Zoom In\n2. Zoom Out\n3. Fit to Screen\n4. 100%\n\nEnter number:');
if(m==='1'){zoom=Math.min(4,zoom*1.25);applyZoom();}
if(m==='2'){zoom=Math.max(0.1,zoom/1.25);applyZoom();}
if(m==='3'){const cont=document.getElementById('canvasContainer');zoom=Math.min(cont.clientWidth/W,cont.clientHeight/H)*0.9;applyZoom();}
if(m==='4'){zoom=1;applyZoom();}
}
function applyZoom(){
document.getElementById('canvasWrapper').style.transform=`scale(${zoom})`;
document.getElementById('canvasWrapper').style.transformOrigin='center center';
document.getElementById('statusZoom').textContent=Math.round(zoom*100)+'%';
}
function resizeCanvas(nw,nh){
layers.forEach(l=>{
const temp=document.createElement('canvas');
temp.width=l.canvas.width;
temp.height=l.canvas.height;
temp.getContext('2d').drawImage(l.canvas,0,0);
l.canvas.width=nw;
l.canvas.height=nh;
l.ctx.drawImage(temp,0,0);
});
W=nw;H=nh;
mainCanvas.width=previewCanvas.width=W;
mainCanvas.height=previewCanvas.height=H;
document.getElementById('canvasWrapper').style.width=W+'px';
document.getElementById('canvasWrapper').style.height=H+'px';
updateStatus();
render();
saveHistory('Resize Canvas');
}
function flipLayer(dir){
const l=layers[activeLayerIdx];
const temp=document.createElement('canvas');
temp.width=W;temp.height=H;
const tc=temp.getContext('2d');
tc.drawImage(l.canvas,0,0);
l.ctx.clearRect(0,0,W,H);
l.ctx.save();
if(dir==='h'){l.ctx.scale(-1,1);l.ctx.drawImage(temp,-W,0);}
else{l.ctx.scale(1,-1);l.ctx.drawImage(temp,0,-H);}
l.ctx.restore();
render();
saveHistory('Flip '+dir);
}
function rotateLayer(){
const l=layers[activeLayerIdx];
const temp=document.createElement('canvas');
temp.width=W;temp.height=H;
temp.getContext('2d').drawImage(l.canvas,0,0);
l.ctx.clearRect(0,0,W,H);
l.ctx.save();
l.ctx.translate(W/2,H/2);
l.ctx.rotate(Math.PI/2);
l.ctx.drawImage(temp,-H/2,-W/2);
l.ctx.restore();
render();
saveHistory('Rotate 90¬∞');
}
function updateStatus(){
document.getElementById('statusSize').textContent=W+' √ó '+H;
}

function saveImage(format='png'){
const link=document.createElement('a');
const tempCanvas=document.createElement('canvas');
tempCanvas.width=W;tempCanvas.height=H;
const tctx=tempCanvas.getContext('2d');
for(let i=layers.length-1;i>=0;i--){
const l=layers[i];
if(!l.visible)continue;
tctx.globalAlpha=l.opacity;
tctx.globalCompositeOperation=l.blendMode;
tctx.drawImage(l.canvas,0,0);
}
link.download='image.'+format;
link.href=tempCanvas.toDataURL('image/'+format);
link.click();
}

function exportFlattened(){
saveImage('png');
}

function fillWithColor(color){
const l=layers[activeLayerIdx];
if(!l||!l.visible)return;
l.ctx.fillStyle=color;
if(selection){
l.ctx.fillRect(selection.x,selection.y,selection.w,selection.h);
}else{
l.ctx.fillRect(0,0,W,H);
}
render();
saveHistory('Fill');
}

function invertSelection(){
if(!selection){
selection={x:0,y:0,w:W,h:H};
}
// For simplicity, just select all if inverting (true invert would need masking)
render();
}

function copySelection(){
if(!selection)return;
const l=layers[activeLayerIdx];
window.copiedData={
imgData:l.ctx.getImageData(selection.x,selection.y,selection.w,selection.h),
w:selection.w,
h:selection.h
};
}

function cutSelection(){
copySelection();
deleteSelection();
}

init();
</script>
</body>
</html>